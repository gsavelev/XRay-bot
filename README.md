**Язык / Language:** <ins>Русский</ins> **|** [English](./docs/README.en_US.md)

<div id="header" align="center"><h1>XRay VPN bot [Telegram]</h1></div>

## Описание проекта

Этот проект представляет собой Telegram бота для управления VPN подписками через панель управления 3X-UI. Бот позволяет пользователям выпускать подписки на VPN, управлять своими профилями, а администраторам — управлять пользователями и отслеживать статистику.

Основные возможности:

- Регистрация пользователей
- Создание и удаление VPN профилей (VLESS) в панели 3X-UI
- Административное меню для управления пользователями и рассылки сообщений
- Статистика использования трафика

## Установка и настройка

### Предварительные требования

- Python 3.10+
- Панель управления 3X-UI
   - Создан inbound с параметром "Безопасность `Reality`"
- Telegram бот (созданный через `@BotFather`)

### Шаги установки

1. Клонируйте репозиторий:

```bash
git clone https://gitlab.thinkmobile.agency/g.savelyev/XRay-bot
cd XRay-bot
```

2. Установите зависимости:

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

3. Настройте переменные окружения:

```bash
cp src/.env.example src/.env
# Отредактируйте .env файл со своими значениями
```

4. Создайте директорию для хранения базы данных:

``` bash
mkdir -p ./app/data
```

5. Запустите бота:

```bash
python3 src/app.py
```

### Настройка переменных окружения

Обязательные параметры в `.env`:

- `BOT_TOKEN` - токен вашего Telegram бота от @BotFather
- `ADMINS` - ID администраторов через запятую
- `CHAT_ID` - ID чата / группы с пользователями
- `XUI_API_URL` - URL панели 3X-UI (например: http://ip:54321)
- `XUI_USERNAME` и `XUI_PASSWORD` - учетные данные панели
- `INBOUND_ID` - ID инбаунда в панели 3X-UI
- Параметры Reality (публичный ключ, fingerprint, SNI и т.д.)

## Техническая архитектура

### Файловая структура

```
./
├── src
│   ├── .env.example        # Пример файла конфигурации
│   ├── app.py              # Основной файл приложения
│   ├── config.py           # Конфигурация приложения
│   ├── database.py         # Модели и функции базы данных
│   ├── functions.py        # Функции для работы с 3X-UI API
│   └── handlers.py         # Обработчики команд и callback'ов
├── docs                    # Документация на других языках
│   └── README.en_US        # Документация на английском языке
├── app
│   └── data
│   │   └── users.db        # Файл базы данных SQLite. Создается при первом запуске бота
├── Dockerfile              # Конфигурация контейнера
├── README.md               # Документация на русском языке
└── requirements.txt        # Зависимости проекта
```

### База данных

Проект использует `SQLite` с `SQLAlchemy ORM`. Основные таблицы:

1. **`users`** - информация о пользователях:

   - `telegram_id` - ID пользователя в Telegram
   - `vless_profile_data` - данные VPN профиля в JSON
   - `chat_member` - флаг членства в чате
   - `is_admin` - флаг администратора
1. **`static_profiles`** - статические VPN профили:

   - `name` - имя профиля
   - `vless_url` - VLESS ссылка

### Основные компоненты

#### 1. `app.py`

Главный файл приложения, который:

- Инициализирует базу данных
- Запускает фоновую задачу ревизии профилей
- Запускает polling бота

#### 2. `config.py`

Загрузка и валидация конфигурации через `Pydantic`. Содержит:

- Настройки подключения к 3X-UI панели
- Параметры Reality протокола

#### 3. `database.py`

Модели и функции для работы с базой данных:

- Модель `User` для хранения пользователей
- Модель `StaticProfile` для статических профилей
- Функции управления профилями

#### 4. `functions.py`

Класс `XUIAPI` для взаимодействия с панелью **3X-UI**:

- Аутентификация в панели
- Создание и удаление клиентов
- Получение статистики использования
- Генерация VLESS URL

#### 5. `handlers.py`

Обработчики команд и callback'ов:

- Команды `/start` и `/menu`
- Административные функции
- Управление профилями

## Административные функции

Администраторы имеют доступ к специальному меню с функциями:

- Просмотр списка пользователей
- Статистика использования сети
- Рассылка сообщений пользователям
- Управление статическими профилями

## Интеграция с **3X-UI**

Бот взаимодействует с панелью **3X-UI** через ее API:

1. Аутентификация по логину/паролю
2. Получение данных инбаунда
3. Добавление клиентов в настройки инбаунда
4. Обновление конфигурации инбаунда

## Генерация VLESS URL

Формат VLESS URL для Reality:

```
vless://{client_id}@{host}:{port}?type=tcp&security=reality&pbk={public_key}&fp={fingerprint}&sni={sni}&sid={short_id}&spx={spider_x}#{remark}
```

## Мониторинг и уведомления

Бот автоматически каждый час проверяет пользователей и:

- Удаляет профили пользователей, которые не состоят в чате / группе 

## Безопасность

- Все чувсвительные данные хранятся в переменных окружения
- Используется валидация конфигурации через Pydantic
- Ограниченный доступ к административным функциям

## Возможные проблемы и решения

1. **Ошибки подключения к 3X-UI** - проверьте URL и учетные данные
3. **Ошибки базы данных** - проверьте права на запись в директории
4. **Не работают уведомления** - проверьте настройки времени и часового пояса

---

*Для дополнительной информации обращайтесь к документации [aiogram](https://docs.aiogram.dev/en/latest/) и [3X-UI](https://github.com/MHSanaei/3x-ui/wiki).*